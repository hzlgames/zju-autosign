<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>用户自助面板 - ZJU 云助理</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Noto+Sans+SC:wght@300;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #00f2ff;
      --secondary: #ff0055;
      --bg-dark: #0a0b1e;
      --glass-bg: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.1);
      --text-main: #ffffff;
      --text-dim: rgba(255, 255, 255, 0.6);
    }

    body {
      background-color: var(--bg-dark);
      font-family: 'Noto Sans SC', sans-serif;
      color: var(--text-main);
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    /* 极光背景 */
    .aurora-bg {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      z-index: -2;
      background: radial-gradient(circle at 10% 20%, rgba(68, 0, 255, 0.15) 0%, transparent 40%),
                  radial-gradient(circle at 90% 80%, rgba(255, 0, 85, 0.15) 0%, transparent 40%),
                  radial-gradient(circle at 50% 50%, rgba(0, 242, 255, 0.05) 0%, transparent 60%);
      animation: pulse-bg 10s ease-in-out infinite alternate;
    }

    @keyframes pulse-bg {
      0% { transform: scale(1); opacity: 0.8; }
      100% { transform: scale(1.1); opacity: 1; }
    }

    /* 玻璃拟态卡片 */
    .glass-card {
      background: var(--glass-bg);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .glass-card:hover {
      box-shadow: 0 10px 40px rgba(0, 242, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
    }

    /* 覆盖 Bootstrap 样式 */
    .card {
      background: transparent;
      border: none;
    }
    
    .navbar {
      background: rgba(10, 11, 30, 0.8) !important;
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--glass-border);
    }

    .form-control, .form-select {
      background-color: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--glass-border);
      color: white;
      border-radius: 8px;
      padding: 0.8rem 1rem;
    }
    
    .form-control:focus, .form-select:focus {
      background-color: rgba(0, 0, 0, 0.5);
      border-color: var(--primary);
      box-shadow: 0 0 15px rgba(0, 242, 255, 0.3);
      color: white;
    }
    
    .form-control::placeholder {
      color: rgba(255, 255, 255, 0.3);
    }

    /* 按钮样式 */
    .btn-primary {
      background: linear-gradient(135deg, rgba(0, 242, 255, 0.2), rgba(0, 242, 255, 0));
      border: 1px solid var(--primary);
      color: var(--primary);
      box-shadow: 0 0 15px rgba(0, 242, 255, 0.1);
      font-weight: bold;
      letter-spacing: 1px;
      transition: all 0.3s ease;
    }
    
    .btn-primary:hover, .btn-primary:active {
      background: var(--primary);
      color: #000;
      box-shadow: 0 0 30px rgba(0, 242, 255, 0.5);
      border-color: var(--primary);
    }

    .btn-success {
      background: linear-gradient(135deg, rgba(45, 255, 120, 0.2), rgba(45, 255, 120, 0));
      border: 1px solid #2dff78;
      color: #2dff78;
    }
    
    .btn-success:hover {
      background: #2dff78;
      color: #000;
      box-shadow: 0 0 30px rgba(45, 255, 120, 0.5);
      border-color: #2dff78;
    }

    .nav-tabs .nav-link {
      color: var(--text-dim);
      border: none;
      border-bottom: 2px solid transparent;
      transition: all 0.3s;
    }
    
    .nav-tabs .nav-link.active {
      background: transparent;
      color: var(--primary);
      border-bottom: 2px solid var(--primary);
      text-shadow: 0 0 10px rgba(0, 242, 255, 0.5);
    }
    
    .nav-tabs .nav-link:hover {
      color: white;
      border-color: transparent;
    }

    /* 状态指示器 */
    .status-indicator-box {
      width: 70px; height: 70px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.3);
      border: 1px solid var(--glass-border);
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      transition: all 0.5s;
    }
    
    .status-running {
      border-color: #2dff78;
      box-shadow: 0 0 30px rgba(45, 255, 120, 0.2), inset 0 0 20px rgba(45, 255, 120, 0.1);
    }
    
    .status-running i {
      text-shadow: 0 0 15px #2dff78;
    }

    /* 日志面板 */
    .log-panel {
      background-color: rgba(0, 0, 0, 0.6);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      font-family: 'JetBrains Mono', 'Consolas', monospace;
      color: #a0a0b0;
      font-size: 0.85rem;
      scrollbar-width: thin;
      scrollbar-color: var(--primary) rgba(0,0,0,0.3);
    }
    
    .log-entry {
      padding: 4px 8px;
      border-radius: 4px;
      transition: background 0.2s;
    }
    
    .log-entry:hover {
      background: rgba(255,255,255,0.05);
    }

    /* 开关控件 */
    .form-check-input {
      background-color: rgba(0,0,0,0.5);
      border-color: var(--glass-border);
    }
    .form-check-input:checked {
      background-color: var(--primary);
      border-color: var(--primary);
      box-shadow: 0 0 10px var(--primary);
    }

    /* 模态框 */
    .modal-content {
      background: rgba(16, 18, 27, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      color: white;
    }
    .modal-header, .modal-footer {
      border-color: var(--glass-border);
    }
    .btn-close {
      filter: invert(1);
    }

    /* 文字排版 */
    h1, h4, h5, h6 {
      font-family: 'Montserrat', sans-serif;
    }
    .text-muted { color: rgba(255,255,255,0.4) !important; }
    .text-dark { color: white !important; } /* 强制覆盖 Bootstrap */
    .bg-light { background-color: rgba(255,255,255,0.05) !important; }
    .bg-white { background-color: transparent !important; }

    /* 全局滚动条美化 */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.15);
      border-radius: 3px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    /* Firefox 适配 */
    html {
      scrollbar-width: thin;
      scrollbar-color: rgba(255, 255, 255, 0.15) transparent;
    }
  </style>
</head>
<body>
  <div class="aurora-bg"></div>
  
  <!-- 登录/注册页面 -->
  <div id="authPage">
    <a href="/" class="btn btn-sm btn-outline-light position-absolute top-0 start-0 m-3 rounded-pill text-decoration-none" style="z-index: 1000; border-color: var(--glass-border); backdrop-filter: blur(5px);">
      <i class="bi bi-arrow-left me-1"></i> 返回主页
    </a>
    <div class="container d-flex flex-column align-items-center justify-content-center min-vh-100">
      <div class="text-center mb-5">
        <h1 class="display-4 fw-bold mb-2" style="background: linear-gradient(to right, #fff, #00f2ff); -webkit-background-clip: text; color: transparent;">
          ZJU Cloud Assistant
        </h1>
        <p class="lead" style="color: var(--primary); letter-spacing: 2px; text-transform: uppercase; font-size: 0.9rem;">
          Secure · Automated · Intelligent
        </p>
      </div>

      <div class="glass-card p-4 p-md-5 w-100" style="max-width: 500px;">
        <ul class="nav nav-tabs nav-fill mb-4 border-bottom-0" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active fw-bold" id="login-tab" data-bs-toggle="tab" data-bs-target="#login" type="button">
              登录
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link fw-bold" id="signup-tab" data-bs-toggle="tab" data-bs-target="#signup" type="button">
              注册
            </button>
          </li>
        </ul>

        <div class="tab-content">
          <!-- 登录 -->
          <div class="tab-pane fade show active" id="login">
            <div class="mb-4">
              <label class="form-label text-primary small fw-bold">用户凭证 (TOKEN)</label>
              <div class="input-group">
                <span class="input-group-text bg-transparent border-end-0 text-primary" style="border-color: var(--glass-border);"><i class="bi bi-key-fill"></i></span>
                <input type="text" class="form-control border-start-0 ps-0" id="loginToken" placeholder="在此粘贴您的凭证...">
              </div>
            </div>
            <div class="mb-4">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="loginRemember">
                <label class="form-check-label text-dim small" for="loginRemember">记住设备</label>
              </div>
            </div>
            <button class="btn btn-primary w-100 py-3 rounded-pill" onclick="loginWithToken()">
              <i class="bi bi-box-arrow-in-right me-2"></i> 建立连接
            </button>
          </div>

          <!-- 注册 -->
          <div class="tab-pane fade" id="signup">
            <div class="alert bg-transparent border border-info d-flex align-items-center mb-3 text-info" style="border-style: dashed !important;">
              <i class="bi bi-terminal me-2"></i>
              <div class="small">需要邀请码</div>
            </div>
            <div class="mb-3">
              <input type="text" class="form-control" id="signupInvite" placeholder="邀请码">
            </div>
            <div class="mb-3">
              <input type="text" class="form-control" id="signupUsername" placeholder="学号">
            </div>
            <div class="mb-4">
              <input type="password" class="form-control" id="signupPassword" placeholder="密码">
            </div>
            <div class="mb-4">
              <label class="form-label text-dim small mb-3">认证模式</label>
              <div class="d-flex gap-3">
                <label class="card glass-card p-3 w-50 cursor-pointer mb-0" style="border-radius: 8px; cursor: pointer;" for="signupModePassword">
                  <div class="d-flex align-items-start">
                    <div class="form-check mt-1">
                        <input class="form-check-input" type="radio" name="signupAuthMode" id="signupModePassword" value="password_persist" checked>
                    </div>
                    <div class="ms-2">
                        <div class="text-white small fw-bold mb-1">自动续期</div>
                        <div style="font-size: 11px; color: rgba(255, 255, 255, 0.8);">推荐。加密存储。</div>
                    </div>
                  </div>
                </label>
                
                <label class="card glass-card p-3 w-50 mb-0" style="border-radius: 8px; opacity: 0.5; cursor: not-allowed;">
                  <div class="d-flex align-items-start">
                    <div class="form-check mt-1">
                        <input class="form-check-input" type="radio" name="signupAuthMode" id="signupModeCookie" value="secure_cookie" disabled>
                    </div>
                    <div class="ms-2">
                        <div class="text-white small fw-bold mb-1">安全 Cookie (暂未开放)</div>
                        <div style="font-size: 11px; color: rgba(255, 255, 255, 0.8);">一次性登录，不保存密码。</div>
                    </div>
                  </div>
                </label>
              </div>
            </div>
            <button class="btn btn-success w-100 py-3 rounded-pill" onclick="signup()">
              <i class="bi bi-person-plus-fill me-2"></i> 创建身份
            </button>
          </div>
        </div>
      </div>
      <div class="text-center mt-4 text-dim small" style="opacity: 0.3;">
        系统状态：在线
      </div>
    </div>
  </div>

  <!-- 用户仪表盘 -->
  <div id="dashboardPage" style="display: none;">
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark mb-4 sticky-top">
      <div class="container">
        <a class="navbar-brand fw-bold" href="/" style="color: var(--primary);">
          <i class="bi bi-cpu-fill me-2"></i>云助理
        </a>
        <button class="btn btn-sm btn-outline-light rounded-pill px-3" onclick="logout()" style="border-color: var(--glass-border);">
          断开连接 <i class="bi bi-power ms-1"></i>
        </button>
      </div>
    </nav>

    <div class="container pb-5">
      <div class="row g-4">
        <!-- 左侧：状态与控制 -->
        <div class="col-lg-8">
          <!-- 状态卡片 -->
          <div class="glass-card mb-4 p-4">
            <div class="d-flex align-items-center mb-4">
              <div class="flex-shrink-0">
                 <div id="statusIndicatorBox" class="status-indicator-box">
                    <i class="bi bi-pause-fill fs-2" id="statusIcon" style="color: rgba(255,255,255,0.5);"></i>
                 </div>
              </div>
              <div class="flex-grow-1 ms-4">
                <h4 class="mb-1 fw-bold text-white" id="statusText">系统待机</h4>
                <div class="text-dim small" id="statusDetail">等待指令...</div>
              </div>
              <div>
                 <span class="badge rounded-pill" style="background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border);">
                   <i class="bi bi-arrow-repeat spin"></i> 自动
                 </span>
              </div>
            </div>
            
            <div class="row g-3">
              <div class="col-md-6">
                <button class="btn btn-success w-100 py-3 rounded-pill shadow-lg" onclick="startTask()" id="btnStart">
                  <i class="bi bi-play-fill me-1"></i> 启动协议
                </button>
              </div>
              <div class="col-md-6">
                <button class="btn btn-outline-light w-100 py-3 rounded-pill" onclick="stopTask()" id="btnStop" style="border-color: rgba(255,255,255,0.2);">
                  <i class="bi bi-stop-fill me-1"></i> 终止任务
                </button>
              </div>
            </div>
          </div>

          <!-- 凭证备份 -->
          <div class="glass-card mb-4 p-0 overflow-hidden">
            <div class="p-4 border-bottom" style="border-color: var(--glass-border) !important;">
              <a class="d-flex align-items-center text-decoration-none text-white" data-bs-toggle="collapse" href="#tokenBackup" role="button">
                <i class="bi bi-shield-lock text-primary me-3 fs-5"></i>
                <span class="fw-bold">身份凭证</span>
                <i class="bi bi-chevron-down ms-auto text-dim"></i>
              </a>
            </div>
            <div class="collapse show" id="tokenBackup">
              <div class="p-4 bg-dark bg-opacity-25">
                <div class="alert bg-transparent border border-warning text-warning small mb-3">
                  <i class="bi bi-exclamation-triangle-fill me-2"></i>
                  请妥善保管此凭证，它是您唯一的访问密钥。
                </div>
                <div class="input-group">
                  <input type="text" class="form-control font-monospace text-primary border-end-0" id="tokenDisplay" readonly style="letter-spacing: 1px;">
                  <button class="btn btn-outline-primary border-start-0" onclick="copyToken()">
                    复制
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- 日志面板 -->
          <div class="glass-card p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0 fw-bold text-white"><i class="bi bi-terminal me-2 text-secondary"></i>系统日志</h5>
              <div>
                <button class="btn btn-sm btn-link text-dim text-decoration-none" onclick="refreshLogs()">
                  <i class="bi bi-arrow-clockwise"></i> 刷新
                </button>
                <button class="btn btn-sm btn-link text-danger text-decoration-none" onclick="clearLogs()">
                  <i class="bi bi-trash"></i> 清空
                </button>
              </div>
            </div>
            <div class="log-panel p-3" id="logsContent" style="height: 400px; overflow-y: auto;">
              <div class="d-flex align-items-center justify-content-center h-100 text-dim">
                <span class="spinner-border spinner-border-sm me-2 text-primary"></span> 正在建立连接...
              </div>
            </div>
          </div>
        </div>

        <!-- 右侧：配置面板 -->
        <div class="col-lg-4">
          <div class="sticky-top" style="top: 100px; z-index: 100; max-height: calc(100vh - 120px); overflow-y: auto;">
            <div class="glass-card">
            <div class="p-4 border-bottom" style="border-color: var(--glass-border) !important;">
              <h5 class="mb-0 fw-bold text-white"><i class="bi bi-sliders me-2 text-primary"></i>配置</h5>
            </div>
            <div class="p-4">
              <form id="configForm">
                <h6 class="text-uppercase text-dim small fw-bold mb-3 ls-1">账户</h6>
                <div class="mb-3">
                  <input type="text" class="form-control" id="cfgUsername" placeholder="ID">
                </div>
                <div class="mb-3">
                  <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" name="cfgAuthMode" id="cfgModePassword" value="password_persist" checked>
                    <label class="form-check-label small text-white" for="cfgModePassword">自动续期模式</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="cfgAuthMode" id="cfgModeCookie" value="secure_cookie" disabled>
                    <label class="form-check-label small text-dim" for="cfgModeCookie">仅 Cookie (已锁定)</label>
                  </div>
                </div>
                <div class="mb-4 position-relative">
                  <input type="password" class="form-control pe-5" id="cfgCurrentPassword" placeholder="更新密码">
                  <i class="bi bi-eye position-absolute top-50 end-0 translate-middle-y me-3 text-dim" onclick="toggleCurrentPassword()" id="pwdEye" style="cursor: pointer;"></i>
                </div>

                <h6 class="text-uppercase text-dim small fw-bold mb-3 ls-1 mt-4">策略</h6>
                <div class="mb-3">
                  <label class="form-label small text-dim">首选定位节点<br>注：轮询策略，不影响签到结果</label>
                  <select class="form-select" id="cfgRaderAt">
                    <option value="ZJGD1">紫金港 - 东一 (ZJG East 1)</option>
                    <option value="ZJGX1">紫金港 - 西区 (ZJG West)</option>
                    <option value="ZJGB1">紫金港 - 段永平 (ZJG DYP)</option>
                    <option value="ZJG4">紫金港 - 大西区 (ZJG Big West)</option>
                    <option value="YQ4">玉泉 - 教四 (YQ 4)</option>
                    <option value="YQ1">玉泉 - 教一 (YQ 1)</option>
                    <option value="YQ7">玉泉 - 教七 (YQ 7)</option>
                    <option value="YQSS">玉泉 - 宿舍 (YQ Dorm)</option>
                    <option value="ZJ1">之江 1 (ZJ 1)</option>
                    <option value="ZJ2">之江 2 (ZJ 2)</option>
                    <option value="HJC1">华家池 1 (HJC 1)</option>
                    <option value="HJC2">华家池 2 (HJC 2)</option>
                  </select>
                </div>

                <div class="bg-dark bg-opacity-25 rounded p-3 mb-4 border border-secondary border-opacity-25">
                  <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="cfgEnableSchedule">
                    <label class="form-check-label fw-bold small text-white" for="cfgEnableSchedule">AI 调度器</label>
                  </div>
                  <div class="d-flex align-items-center gap-2">
                    <input type="text" class="form-control form-control-sm text-center" id="cfgWindowStart" value="08:00">
                    <span class="text-dim">-</span>
                    <input type="text" class="form-control form-control-sm text-center" id="cfgWindowEnd" value="22:00">
                  </div>
                </div>

                <div class="mb-4">
                  <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="cfgLogEmptyRollcall">
                    <label class="form-check-label small text-dim" for="cfgLogEmptyRollcall">详细日志</label>
                  </div>
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="cfgEnabled" checked>
                    <label class="form-check-label text-white" for="cfgEnabled">账户激活</label>
                  </div>
                </div>

                <button type="button" class="btn btn-primary w-100 py-3 rounded-pill fw-bold" onclick="saveConfig()">
                  <i class="bi bi-save me-2"></i> 保存更改
                </button>
              </form>
            </div>
          </div>

          <div class="glass-card mt-4 p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0 fw-bold text-white"><i class="bi bi-robot me-2 text-success"></i>钉钉机器人</h5>
              <button class="btn btn-sm btn-outline-primary rounded-pill" onclick="showBotModal()"><i class="bi bi-plus-lg"></i> 添加</button>
            </div>
            <div id="botsList" class="small text-dim">加载中...</div>
          </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast 容器 -->
  <div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer" style="z-index: 1060;"></div>

  <!-- 机器人编辑模态框 -->
  <div class="modal fade" id="botModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header border-0">
          <h5 class="modal-title fw-bold text-white" id="botModalTitle">配置钉钉机器人</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <!-- 新增引导区域 -->
          <div class="mb-4 p-3 rounded border border-secondary border-opacity-25" style="background: rgba(0, 0, 0, 0.2);">
             <div class="d-flex justify-content-between align-items-center">
                <div>
                   <h6 class="fw-bold text-white mb-1"><i class="bi bi-lightbulb-fill me-2 text-warning"></i>不知道如何配置？</h6>
                   <p class="small text-dim mb-0">
                     查看详细的图文教程，了解如何获取 Webhook 和签名。
                   </p>
                </div>
                <a href="/bot-guide.html" target="_blank" class="btn btn-sm btn-outline-primary rounded-pill px-3 ms-2 text-nowrap">
                  查看教程 <i class="bi bi-arrow-right-short"></i>
                </a>
             </div>
          </div>

          <input type="hidden" id="botId">
          <div class="mb-3">
            <label class="form-label small text-dim">名称</label>
            <input type="text" class="form-control" id="botName" placeholder="如：我的通知机器人">
          </div>
          <div class="mb-3">
            <label class="form-label small text-dim">Webhook</label>
            <input type="text" class="form-control" id="botWebhook" placeholder="https://oapi.dingtalk.com/robot/send?...">
          </div>
          <div class="mb-3">
            <label class="form-label small text-dim">签名秘钥 (可选)</label>
            <input type="text" class="form-control" id="botSecret" placeholder="未启用签名可留空">
          </div>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="botEnabled" checked>
            <label class="form-check-label text-white" for="botEnabled">启用</label>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="saveBot()">保存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Token 成功模态框 -->
  <div class="modal fade" id="tokenModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header border-0 justify-content-center py-4">
           <div class="text-center">
              <i class="bi bi-check-circle-fill display-3 mb-3 d-block text-success"></i>
              <h4 class="modal-title fw-bold text-white">身份已创建</h4>
           </div>
        </div>
        <div class="modal-body text-center p-4">
          <p class="text-dim mb-4">欢迎加入网络。请妥善保存您的凭证。</p>
          
          <div class="p-3 rounded-3 border mb-4 position-relative" style="background: rgba(0,0,0,0.5); border-color: var(--glass-border) !important;">
            <code class="fs-5 text-primary text-break" id="modalTokenText"></code>
          </div>
          
          <button class="btn btn-outline-primary w-100 mb-3 py-2 fw-bold rounded-pill" onclick="copyModalToken()">
            <i class="bi bi-clipboard me-1"></i> 复制凭证
          </button>
          
          <div class="d-grid">
             <button type="button" class="btn btn-success py-2 fw-bold rounded-pill" onclick="confirmTokenSaved()">
              我已保存
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 确认操作模态框 -->
  <div class="modal fade" id="confirmModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content shadow-lg">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title fw-bold text-white">
             <i class="bi bi-exclamation-octagon-fill text-warning me-2"></i>确认操作
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-4">
          <p id="confirmModalMessage" class="mb-0 text-dim lh-base"></p>
        </div>
        <div class="modal-footer border-0 pt-0 px-4 pb-4">
          <button type="button" class="btn btn-outline-light rounded-pill px-4" data-bs-dismiss="modal" id="btnConfirmCancel">取消</button>
          <button type="button" class="btn btn-primary rounded-pill px-4" id="btnConfirmOk">继续</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Cookie 获取帮助模态框 -->
  <div class="modal fade" id="cookieHelpModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white border-0">
          <h5 class="modal-title fw-bold">
            <i class="bi bi-cookie me-2"></i>如何获取 Cookie?
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-4 text-white">
          <p class="text-dim">请登录 courses.zju.edu.cn 并在开发者控制台复制 document.cookie。</p>
          <pre class="bg-dark p-3 rounded"><code id="cookieScript" class="text-success">copy(document.cookie); alert('Cookie Copied!');</code></pre>
          <button class="btn btn-outline-light btn-sm" onclick="copyCookieScript()">复制代码</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    let currentUserToken = null;
    let tokenModalInstance = null;
    let confirmModalInstance = null;
    let cookieHelpModalInstance = null;
    let logsRefreshTimer = null;
    let confirmResolver = null;
    let botModalInstance = null;
    let botsCache = [];

    function escapeHtml(unsafe = "") {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function fetchApi(path, options = {}) {
      const headers = { ...(options.headers || {}), "X-User-Token": currentUserToken };
      // 移除 URL 中的 userToken 参数，避免在地址栏或日志中泄露
      return fetch(`${location.origin}${path}`, { ...options, headers });
    }

    document.addEventListener('DOMContentLoaded', function() {
      // 初始化时间选择器
      flatpickr("#cfgWindowStart", {
        enableTime: true,
        noCalendar: true,
        dateFormat: "H:i",
        time_24hr: true,
        defaultDate: "08:00"
      });
      flatpickr("#cfgWindowEnd", {
        enableTime: true,
        noCalendar: true,
        dateFormat: "H:i",
        time_24hr: true,
        defaultDate: "22:00"
      });

      tokenModalInstance = new bootstrap.Modal(document.getElementById('tokenModal'));
      confirmModalInstance = new bootstrap.Modal(document.getElementById('confirmModal'));
      cookieHelpModalInstance = new bootstrap.Modal(document.getElementById('cookieHelpModal'));
      botModalInstance = new bootstrap.Modal(document.getElementById('botModal'));
      
      document.getElementById('btnConfirmOk').addEventListener('click', () => {
        if (confirmResolver) confirmResolver(true);
        confirmModalInstance.hide();
      });

      document.getElementById('btnConfirmCancel').addEventListener('click', () => {
        if (confirmResolver) confirmResolver(false);
      });

      // 监听模态框完全关闭（包括点击 backdrop 或 x 按钮）
      document.getElementById('confirmModal').addEventListener('hidden.bs.modal', () => {
        if (confirmResolver) {
            // 如果 resolver 还在（没被点击按钮消耗掉），说明是点外部/esc关闭，视为取消
            confirmResolver(false);
            confirmResolver = null;
        }
      });
      
      // 尝试自动登录
      const saved = localStorage.getItem('user_token');
      const remember = localStorage.getItem('user_remember') === 'true';
      if (saved && remember) {
        currentUserToken = saved;
        document.getElementById('loginToken').value = saved;
        document.getElementById('loginRemember').checked = true;
        loginWithToken();
      }
    });

    function showCustomConfirm(message) {
        return new Promise((resolve) => {
            confirmResolver = resolve;
            document.getElementById('confirmModalMessage').textContent = message;
            confirmModalInstance.show();
        });
    }

    function showCookieHelp() {
      cookieHelpModalInstance.show();
    }

    function copyCookieScript() {
      const script = document.getElementById('cookieScript').textContent;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(script).then(() => {
          showToast('代码已复制，请到学在浙大控制台粘贴执行', 'success');
        }).catch(() => {
          fallbackCopyTextToClipboard(script);
        });
      } else {
        fallbackCopyTextToClipboard(script);
      }
    }

    function api(path) {
      // 保持 api 函数的原始签名，但在 fetchApi 内部已移除查询参数
      // 这里主要用于兼容旧代码，或者如果某些非敏感 GET 请求仍需要拼接 URL
      // 但在我们的加固方案中，所有请求都应该走 fetchApi 并使用 Header
      return `${location.origin}${path}`;
    }

    function showToast(message, type = 'info') {
      const icon = type === 'success' ? 'check-circle-fill' : type === 'error' ? 'x-circle-fill' : 'info-circle-fill';
      const colorClass = type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : 'bg-primary';
      
      const toastHtml = `
        <div class="toast align-items-center text-white ${colorClass} border-0" role="alert">
          <div class="d-flex">
            <div class="toast-body d-flex align-items-center">
              <i class="bi bi-${icon} me-2 fs-5"></i>
              ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
          </div>
        </div>
      `;
      const container = document.getElementById('toastContainer');
      container.insertAdjacentHTML('beforeend', toastHtml);
      const toastEl = container.lastElementChild;
      const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
      toast.show();
      toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
    }

    async function signup() {
      const inviteCode = document.getElementById('signupInvite').value.trim();
      const username = document.getElementById('signupUsername').value.trim();
      const password = document.getElementById('signupPassword').value.trim();
      const authMode = document.querySelector('input[name="signupAuthMode"]:checked')?.value || 'password_persist';

      if (!inviteCode || !username || !password) {
        showToast('请填写完整信息（邀请码、学号、密码）', 'error');
        return;
      }

      // 极致安全模式提示
      if (authMode === 'secure_cookie') {
        showToast('正在登录获取 Cookie，密码将在完成后销毁...', 'info');
      }

      try {
        const res = await fetch(`${location.origin}/user/signup`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ inviteCode, username, password, authMode }),
        });
        const data = await res.json();

        if (!data.ok) {
          showToast(data.message || '注册失败', 'error');
          return;
        }

        // 显示 Token 模态框
        currentUserToken = data.userToken;
        document.getElementById('modalTokenText').textContent = data.userToken;
        tokenModalInstance.show();
      } catch (e) {
        showToast('请求失败: ' + e.message, 'error');
      }
    }

    // 切换认证模式时更新提示文字
    document.getElementById('cfgModePassword').addEventListener('change', (e) => {
      // 这里的逻辑在 UI 上简化了，暂时保留空函数以防报错
    });
    document.getElementById('cfgModeCookie').addEventListener('change', (e) => {
      // 这里的逻辑在 UI 上简化了
    });

    function copyModalToken() {
      const tokenText = document.getElementById('modalTokenText').textContent;
      // 尝试使用现代 Clipboard API
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(tokenText).then(() => {
          showToast('已复制到剪贴板', 'success');
        }).catch(() => {
          fallbackCopyTextToClipboard(tokenText);
        });
      } else {
        fallbackCopyTextToClipboard(tokenText);
      }
    }

    function confirmTokenSaved() {
      tokenModalInstance.hide();
      localStorage.setItem('user_token', currentUserToken);
      localStorage.setItem('user_remember', 'true');
      showDashboard();
    }

    async function loginWithToken() {
      const token = document.getElementById('loginToken').value.trim();
      if (!token) {
        showToast('请输入登录凭证', 'error');
        return;
      }

      currentUserToken = token;

      try {
        const res = await fetchApi('/user/me/status');
        const data = await res.json();

        if (!data.ok) {
          showToast('凭证无效或已过期', 'error');
          currentUserToken = null;
          return;
        }

        // 保存凭证
        const remember = document.getElementById('loginRemember').checked;
        if (remember) {
          localStorage.setItem('user_token', token);
          localStorage.setItem('user_remember', 'true');
        } else {
          localStorage.removeItem('user_token');
          localStorage.removeItem('user_remember');
        }

        showDashboard();
      } catch (e) {
        showToast('请求失败: ' + e.message, 'error');
        currentUserToken = null;
      }
    }

    function showDashboard() {
      document.getElementById('authPage').style.display = 'none';
      document.getElementById('dashboardPage').style.display = 'block';
      document.getElementById('tokenDisplay').value = currentUserToken;
      loadStatus();
      loadBots();
      refreshLogs();
      
      // 定时刷新日志
      if (logsRefreshTimer) clearInterval(logsRefreshTimer);
      logsRefreshTimer = setInterval(() => refreshLogs(), 30000); // 30秒刷新一次
    }

    function logout() {
      if (logsRefreshTimer) clearInterval(logsRefreshTimer);
      currentUserToken = null;
      localStorage.removeItem('user_token');
      localStorage.removeItem('user_remember');
      document.getElementById('authPage').style.display = 'block';
      document.getElementById('dashboardPage').style.display = 'none';
      showToast('已退出登录', 'info');
    }

    function copyToken() {
      const tokenInput = document.getElementById('tokenDisplay');
      // 尝试使用现代 Clipboard API
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(tokenInput.value).then(() => {
          showToast('已复制到剪贴板', 'success');
        }).catch(() => {
          // 降级处理
          fallbackCopyTextToClipboard(tokenInput.value);
        });
      } else {
        // 降级处理
        fallbackCopyTextToClipboard(tokenInput.value);
      }
    }

    function fallbackCopyTextToClipboard(text) {
      const textArea = document.createElement("textarea");
      textArea.value = text;
      
      // 避免滚动到底部
      textArea.style.top = "0";
      textArea.style.left = "0";
      textArea.style.position = "fixed";

      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();

      try {
        const successful = document.execCommand('copy');
        if (successful) {
          showToast('已复制到剪贴板', 'success');
        } else {
          showToast('复制失败，请手动复制', 'error');
        }
      } catch (err) {
        showToast('复制失败，请手动复制', 'error');
      }

      document.body.removeChild(textArea);
    }

    async function loadStatus() {
      try {
        const res = await fetchApi('/user/me/status');
        const data = await res.json();

        if (!data.ok) {
          showToast('加载状态失败', 'error');
          return;
        }

        const user = data.user || {};
        const core = data.core || {};
        const scheduler = data.scheduler || {};

        // 更新状态指示器 UI
        const box = document.getElementById('statusIndicatorBox');
        const icon = document.getElementById('statusIcon');
        const statusText = document.getElementById('statusText');
        const statusDetail = document.getElementById('statusDetail');

        if (core.running) {
          box.className = 'status-indicator-box status-running';
          icon.className = 'bi bi-activity fs-2';
          icon.style.color = '#2dff78';
          statusText.textContent = '系统运行中';
          statusText.className = 'mb-1 fw-bold text-success';
          statusDetail.textContent = '监控进程已激活。';
        } else {
          box.className = 'status-indicator-box';
          icon.className = 'bi bi-pause-fill fs-2';
          icon.style.color = 'rgba(255,255,255,0.5)';
          statusText.textContent = '系统待机';
          statusText.className = 'mb-1 fw-bold text-white';
          statusDetail.textContent = '等待指令...';
        }

        // 填充账号信息
        document.getElementById('cfgUsername').value = user.username || '';
        hasPassword = !!user.hasPassword;
        hasCookie = !!user.hasCookie;
        document.getElementById('cfgCurrentPassword').value = '';

        // 认证模式与授权状态
        if (user.authMode === 'secure_cookie') {
          document.getElementById('cfgModeCookie').checked = true;
          if (hasCookie) {
            document.getElementById('cfgCurrentPassword').placeholder = 'Cookie 有效';
          } else {
            document.getElementById('cfgCurrentPassword').placeholder = '需要密码以续期 Cookie';
          }
        } else {
          document.getElementById('cfgModePassword').checked = true;
          if (hasPassword) {
            document.getElementById('cfgCurrentPassword').placeholder = '密码已保存 (已隐藏)';
          } else {
            document.getElementById('cfgCurrentPassword').placeholder = '更新密码';
          }
        }
        
        // 填充配置表单
        document.getElementById('cfgRaderAt').value = user.raderAt || 'ZJGD1';

        const startInput = document.getElementById('cfgWindowStart');
        const endInput = document.getElementById('cfgWindowEnd');
        if(startInput._flatpickr) startInput._flatpickr.setDate(user.windowStart || '08:00');
        else startInput.value = user.windowStart || '08:00';
        
        if(endInput._flatpickr) endInput._flatpickr.setDate(user.windowEnd || '22:00');
        else endInput.value = user.windowEnd || '22:00';

        document.getElementById('cfgEnableSchedule').checked = user.enableSchedule || false;
        document.getElementById('cfgLogEmptyRollcall').checked = !!user.logEmptyRollcall;
        document.getElementById('cfgEnabled').checked = user.enabled !== false;
      } catch (e) {
        showToast('请求失败: ' + e.message, 'error');
      }
    }

    function toggleCurrentPassword() {
      const input = document.getElementById('cfgCurrentPassword');
      const eye = document.getElementById('pwdEye');
      if (input.type === 'password') {
        input.type = 'text';
        eye.className = 'bi bi-eye-slash text-primary';
      } else {
        input.type = 'password';
        eye.className = 'bi bi-eye text-dim';
      }
    }

    async function startTask(forceOverride = false) {
      try {
        const res = await fetchApi('/user/me/start', { 
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ forceOverride })
        });
        const data = await res.json();
        
        // 如果需要用户确认
        if (data.needConfirm) {
          const confirmed = await showCustomConfirm(data.message);
          if (confirmed) {
            // 用户确认，带上 forceOverride 重新请求
            return startTask(true);
          } else {
            showToast('已取消启动', 'info');
            return;
          }
        }
        
        showToast(data.ok ? '启动成功' : data.message, data.ok ? 'success' : 'error');
        if (data.ok) loadStatus();
      } catch (e) {
        showToast('请求失败: ' + e.message, 'error');
      }
    }

    async function stopTask(forceOverride = false) {
      try {
        const res = await fetchApi('/user/me/stop', { 
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ forceOverride })
        });
        const data = await res.json();
        
        // 如果需要用户确认
        if (data.needConfirm) {
          const confirmed = await showCustomConfirm(data.message);
          if (confirmed) {
            // 用户确认，带上 forceOverride 重新请求
            return stopTask(true);
          } else {
            showToast('已取消停止', 'info');
            return;
          }
        }
        
        showToast(data.ok ? '停止成功' : data.message, data.ok ? 'success' : 'error');
        if (data.ok) loadStatus();
      } catch (e) {
        showToast('请求失败: ' + e.message, 'error');
      }
    }

    let hasPassword = false;
    let hasCookie = false;

    async function saveConfig() {
      const authMode = document.querySelector('input[name="cfgAuthMode"]:checked')?.value || 'password_persist';
      const password = document.getElementById('cfgCurrentPassword').value || undefined;
      
      const body = {
        username: document.getElementById('cfgUsername').value || undefined,
        password: password,
        authMode: authMode,
        raderAt: document.getElementById('cfgRaderAt').value,
        windowStart: document.getElementById('cfgWindowStart').value,
        windowEnd: document.getElementById('cfgWindowEnd').value,
        enableSchedule: document.getElementById('cfgEnableSchedule').checked,
        logEmptyRollcall: document.getElementById('cfgLogEmptyRollcall').checked,
        enabled: document.getElementById('cfgEnabled').checked,
      };

      // 切换到极致安全模式时必须提供密码
      if (authMode === 'secure_cookie' && !password && !hasCookie) {
        showToast('极致安全模式需要输入密码以获取 Cookie', 'error');
        return;
      }
      // 切换到省心模式时必须提供密码（如果之前没有）
      if (authMode === 'password_persist' && !password && !hasPassword) {
        showToast('省心模式需要填写密码', 'error');
        return;
      }

      if (body.enableSchedule && body.windowStart > body.windowEnd) {
        const confirmed = await showCustomConfirm(
          `您设置的时间窗口 (${body.windowStart} - ${body.windowEnd}) 跨越了午夜。\n\n` +
          `这意味着任务将从当天 ${body.windowStart} 开始，持续运行到次日 ${body.windowEnd}。\n\n` +
          `确认要应用此跨天策略吗？`
        );
        if (!confirmed) {
          showToast('已取消保存', 'info');
          return;
        }
      }

      // 极致安全模式提示
      if (authMode === 'secure_cookie' && password) {
        showToast('正在登录获取 Cookie，密码将在完成后销毁...', 'info');
      }

      try {
        const res = await fetchApi('/user/me/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        const data = await res.json();
        showToast(data.ok ? '保存成功' : data.message, data.ok ? 'success' : 'error');
        if (data.ok) {
          // 清空密码输入框
          document.getElementById('cfgCurrentPassword').value = '';
          loadStatus();
        }
      } catch (e) {
        showToast('请求失败: ' + e.message, 'error');
      }
    }

    async function loadBots() {
      const container = document.getElementById('botsList');
      try {
        const res = await fetchApi('/user/me/dingtalk-bots');
        const data = await res.json();
        if (!data.ok) {
          container.innerHTML = `<div class="text-danger">${data.message || '加载失败'}</div>`;
          return;
        }
        botsCache = data.bots || [];
        renderBots();
      } catch (e) {
        container.innerHTML = `<div class="text-danger">${e.message}</div>`;
      }
    }

    function renderBots() {
      const container = document.getElementById('botsList');
      if (!container) return;
      if (!botsCache || botsCache.length === 0) {
        container.innerHTML = '<div class="text-dim">尚未添加机器人</div>';
        return;
      }
      container.innerHTML = botsCache.map(bot => {
        const badge = bot.enabled ? '<span class="badge bg-success bg-opacity-25 border border-success text-success">启用</span>' : '<span class="badge bg-secondary">停用</span>';
        const secretTag = bot.hasSecret ? '<span class="badge bg-primary bg-opacity-25 border border-primary text-primary ms-1">签名</span>' : '';
        return `<div class="border-bottom border-secondary border-opacity-25 py-2 d-flex justify-content-between align-items-center">
          <div>
            <div class="text-white fw-bold">${escapeHtml(bot.name || '未命名')}</div>
            <div class="text-dim small">ID: ${escapeHtml(bot.id)}</div>
            <div class="mt-1">${badge}${secretTag}</div>
          </div>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-primary" onclick="showBotModal('${escapeHtml(bot.id)}')"><i class="bi bi-pencil"></i></button>
            <button class="btn btn-outline-success" onclick="testBot('${escapeHtml(bot.id)}')"><i class="bi bi-broadcast"></i></button>
            <button class="btn btn-outline-danger" onclick="deleteBot('${escapeHtml(bot.id)}')"><i class="bi bi-trash"></i></button>
          </div>
        </div>`;
      }).join('');
    }

    function showBotModal(botId = null) {
      const bot = botsCache.find(b => b.id === botId);
      document.getElementById('botId').value = bot?.id || '';
      document.getElementById('botName').value = bot?.name || '';
      // 预填已有配置，便于仅修改部分字段
      document.getElementById('botWebhook').value = bot?.webhook || '';
      document.getElementById('botSecret').value = bot?.secret || bot?.secretMasked || '';
      document.getElementById('botEnabled').checked = bot ? bot.enabled !== false : true;
      document.getElementById('botModalTitle').textContent = bot ? '编辑机器人' : '添加机器人';
      botModalInstance.show();
    }

    async function saveBot() {
      const id = document.getElementById('botId').value;
      const name = document.getElementById('botName').value.trim();
      const webhook = document.getElementById('botWebhook').value.trim();
      const secret = document.getElementById('botSecret').value.trim();
      const enabled = document.getElementById('botEnabled').checked;
      if (!webhook && !id) {
        showToast('请输入 webhook', 'error');
        return;
      }
      const payload = { name: name || undefined, webhook: webhook || undefined, secret: secret || undefined, enabled };
      const method = id ? 'PUT' : 'POST';
      const url = id ? `/user/me/dingtalk-bots/${id}` : '/user/me/dingtalk-bots';
      if (id && !webhook) delete payload.webhook;
      if (id && secret === '') payload.secret = '';
      try {
        const res = await fetchApi(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!data.ok) {
          showToast(data.message || '保存失败', 'error');
          return;
        }
        showToast('已保存', 'success');
        botModalInstance.hide();
        loadBots();
      } catch (e) {
        showToast('请求失败: ' + e.message, 'error');
      }
    }

    async function deleteBot(botId) {
      const confirmed = await showCustomConfirm('确定删除该机器人？');
      if (!confirmed) return;
      try {
        const res = await fetchApi(`/user/me/dingtalk-bots/${botId}`, { method: 'DELETE' });
        const data = await res.json();
        showToast(data.ok ? '已删除' : (data.message || '失败'), data.ok ? 'success' : 'error');
        if (data.ok) loadBots();
      } catch (e) {
        showToast('请求失败: ' + e.message, 'error');
      }
    }

    async function testBot(botId) {
      try {
        const res = await fetchApi(`/user/me/dingtalk-bots/${botId}/test`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: '【测试】机器人连接正常' })
        });
        const data = await res.json();
        showToast(data.ok ? '测试已发送' : (data.message || '失败'), data.ok ? 'success' : 'error');
      } catch (e) {
        showToast('请求失败: ' + e.message, 'error');
      }
    }

    async function refreshLogs() {
      try {
        const res = await fetchApi('/user/me/logs');
        const data = await res.json();

        const content = document.getElementById('logsContent');
        
        if (!data.ok) {
          content.innerHTML = `<p class="text-danger text-center mt-4">${data.message || '加载失败'}</p>`;
          return;
        }

        const logs = data.logs || [];
        if (logs.length === 0) {
          content.innerHTML = '<div class="d-flex align-items-center justify-content-center h-100 text-dim">暂无日志</div>';
          return;
        }

        // 反转日志顺序，最新的显示在最上面
        const reversedLogs = [...logs].reverse();

        content.innerHTML = reversedLogs.map(log => {
          const ts = new Date(log.ts);
          const datePart = ts.toLocaleDateString("zh-CN");
          const timePart = ts.toLocaleTimeString("zh-CN", { hour12: false });
          const formattedTime = `${datePart} ${timePart}`;
          let color = '#a0a0b0'; // default info
          let icon = 'info-circle';
          
          if(log.level === 'success') { color = '#2dff78'; icon = 'check-circle'; }
          else if(log.level === 'error') { color = '#ff0055'; icon = 'x-circle'; }
          else if(log.level === 'warn') { color = '#fbbf24'; icon = 'exclamation-triangle'; }
          
          return `
            <div class="log-entry">
              <span style="color: rgba(255,255,255,0.3); margin-right: 8px; font-size: 0.8em;">[${formattedTime}]</span>
              <span style="color: ${color}; font-weight: bold; margin-right: 5px;">${log.level.toUpperCase()}</span>
              <span class="text-white">${escapeHtml(log.message)}</span>
            </div>
          `;
        }).join('');
        
        // 滚动到顶部以显示最新日志
        content.scrollTop = 0;
      } catch (e) {
        console.error('刷新日志失败:', e);
      }
    }

    async function clearLogs() {
      const confirmed = await showCustomConfirm('确定要清空所有日志吗？此操作不可撤销。');
      if (!confirmed) return;
      
      try {
        const res = await fetchApi('/user/me/logs', { method: 'DELETE' });
        const data = await res.json();
        if (data.ok) {
          showToast('日志已清空', 'success');
          refreshLogs();
        } else {
          showToast(data.message || '清空失败', 'error');
        }
      } catch (e) {
        showToast('请求失败: ' + e.message, 'error');
      }
    }
  </script>
</body>
</html>